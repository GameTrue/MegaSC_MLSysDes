PROMPT_TEMPLATE = r"""Внимательно рассмотри приложенное изображение диаграммы. Прочитай КАЖДЫЙ текст на изображении точно как он написан. НЕ ПРИДУМЫВАЙ текст — используй ТОЛЬКО то, что видишь на картинке.

Верни ТОЛЬКО валидный JSON (без markdown-блоков, без лишнего текста):
{
  "diagram_type": "bpmn|flowchart|other",
  "description": "краткое описание диаграммы на русском",
  "steps": [
    {
      "id": "<УНИКАЛЬНЫЙ числовой id: 1, 2, 3, ...>",
      "action": "<ДОСЛОВНЫЙ текст внутри узла; если текста нет — пустая строка>",
      "type": "start|end|task|decision|subprocess",
      "role": "<название swim lane (дорожки) или null>",
      "next_steps": [
        {"to": "<числовой id целевого шага>", "label": "<текст на стрелке или пустая строка>"}
      ]
    }
  ]
}

Правила:
- НЕ ВЫДУМЫВАЙ содержимое. Каждый action — ДОСЛОВНАЯ копия текста из узла на изображении.
- Если текст не читается — напиши "нечитаемо", но НЕ ПРИДУМЫВАЙ.
- Не добавляй markdown, только чистый JSON.
- Каждый шаг имеет УНИКАЛЬНЫЙ числовой id (1, 2, 3...). В next_steps.to ссылайся на эти id.
- Числовые префиксы в тексте узлов (например "7.1", "ИК 7.2") сохраняй в action.

ВАЖНО — развилки (ромбы / gateways):
- Ромб — это ОДИН шаг с type "decision". Текст внутри ромба → action.
- Исходящие стрелки из ромба имеют подписи ("Да", "Нет" и т.п.) — это next_steps.label.
- НЕ создавай отдельные шаги для "Да" и "Нет" — это подписи на стрелках, а НЕ узлы диаграммы!

Swim lanes (дорожки):
- Если диаграмма разделена на горизонтальные или вертикальные дорожки с подписями — название дорожки → поле role для всех узлов внутри неё.
- Если дорожек нет — role = null.

Типы узлов:
- Тонкий круг/овал в начале → type "start".
- Жирный круг/точка в конце → type "end".
- Прямоугольник → type "task".
- Ромб → type "decision".
- Прямоугольник с маркером "+" внизу (подпроцесс) → type "subprocess".

- Если диаграмма использует BPMN-нотацию (события, шлюзы, пулы/дорожки) → diagram_type = "bpmn".
- Порядок обхода: слева-направо, сверху-вниз от стартового узла.

Пример 1 — простая блок-схема (3 задачи в цикле):
{"diagram_type":"flowchart","description":"ИК 7. Управление технологическим стеком","steps":[{"id":1,"action":"7.1. Принятие технологии","type":"task","role":null,"next_steps":[{"to":2,"label":""}]},{"id":2,"action":"ИК 7.2. Использование технологии в продуктах","type":"task","role":null,"next_steps":[{"to":3,"label":""}]},{"id":3,"action":"ИК 7.3. Отказ от технологии или изменение условий использования","type":"task","role":null,"next_steps":[{"to":2,"label":""}]}]}

Пример 2 — блок-схема с развилкой:
{"diagram_type":"flowchart","description":"Определение необходимости назначения роли в зависимости от принадлежности организации к государственной собственности","steps":[{"id":0,"action":"Начало","type":"start","role":null,"next_steps":[{"to":1,"label":""}]},{"id":1,"action":"","type":"decision","role":null,"next_steps":[{"to":2,"label":"Организации с государственной собственностью: РФ, субъектам РФ или муниципальным образованиям принадлежит более 50 % акций"},{"to":3,"label":"нет"}]},{"id":2,"action":"Выполнить сценарий выбора СФЛ при назначении роли","type":"task","role":null,"next_steps":[{"to":3,"label":""}]},{"id":3,"action":"Заполнить сроки действия роли","type":"task","role":null,"next_steps":[{"to":4,"label":""}]},{"id":4,"action":"Заполнить сроки атрибуты роли","type":"task","role":null,"next_steps":[{"to":5,"label":""}]},{"id":5,"action":"Конец","type":"end","role":null,"next_steps":[]}]}
"""


GENERATE_PROMPT = r"""Ты — генератор диаграмм. По текстовому описанию алгоритма или процесса создай диаграмму в формате Mermaid.

Правила:
- Используй синтаксис Mermaid flowchart (graph TD для вертикальных, graph LR для горизонтальных).
- Начало → круглый узел: id(["Начало"])
- Конец → круглый узел: id(["Конец"])
- Задача → прямоугольник: id["Текст задачи"]
- Решение → ромб: id{"Вопрос?"}
- Подписи на стрелках: -->|"Да"| или -->|"Нет"|
- Используй русский язык для текста узлов если описание на русском.
- Если в описании есть swim lanes (роли/акторы), используй subgraph для каждой дорожки.
- Каждый узел должен иметь уникальный id (A, B, C... или осмысленные имена).

Верни ТОЛЬКО код Mermaid без markdown-обёрток, без ```mermaid, без пояснений — только сам код диаграммы.

Пример ввода: "Пользователь отправляет заявку. Система проверяет данные. Если данные корректны — одобряем, иначе — отклоняем."

Пример вывода:
graph TD
    A(["Начало"]) --> B["Отправка заявки"]
    B --> C{"Данные корректны?"}
    C -->|"Да"| D["Одобрение"]
    C -->|"Нет"| E["Отклонение"]
    D --> F(["Конец"])
    E --> F
"""
